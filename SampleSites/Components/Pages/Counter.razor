@page "/counter"
@using System.Runtime.InteropServices
@implements IAsyncDisposable
@inject HotKeys HotKeys

<h1>Counter</h1>

<p>Current count: @_currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>

@if (_isWasm)
{
    // "PreventDefault = true" will works only on a Blazor WebAssembly app.
    <div class="hot-keys-cheat-sheet alert alert-secondary mt-4">
        In this page, <span class="key">Ctrl</span>+<span class="key">A</span> (select all of the contents) is disallowed.
    </div>
}

<div class="mt-2">
    <input type="text" class="form-control" placeholder="Hotkeys are enabled in this field" />
</div>

<div class="mt-2 disabled-hotkeys">
    <input type="text" class="form-control" placeholder="Hotkeys are disabled in this field" />
</div>

<div class="mt-2 d-flex">
    <input type="text" class="form-control disabled-state-hotkeys" placeholder="Hotkey 'Y' is @HotKeyState in C#" />
    <button class="state-trigger-button btn btn-secondary text-nowrap ml-2" @onclick="OnTriggerDisabledState">
        Trigger state
    </button>
</div>

<div class="mt-1">
    <span>State: <b>@HotKeyState</b></span>
</div>

@code {
    private readonly bool _isWasm = OperatingSystem.IsBrowser();

    private int _currentCount = 0;

    private HotKeysContext? _hotKeysContext;

    private string HotKeyState => _hotKeysContext?.GetHotKey(Code.Y).State.Disabled == true ? "disabled" : "enabled";

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _hotKeysContext = this.HotKeys.CreateContext()
                .Add(Code.U, this.IncrementCount, new() { Exclude = Exclude.None, ExcludeSelector = ".disabled-hotkeys *" })
                .Add(Code.Y, this.IncrementCount, new() { Exclude = Exclude.None, Disabled = true })

                // Test for Number Pad
                .Add(Code.Numpad0, this.IncrementCount)
                .Add(Code.Numpad1, this.IncrementCount)
                .Add(Code.Numpad2, this.IncrementCount)
                .Add(Code.Numpad3, this.IncrementCount)
                .Add(Code.Numpad4, this.IncrementCount)
                .Add(Code.Numpad5, this.IncrementCount)
                .Add(Code.Numpad6, this.IncrementCount)
                .Add(Code.Numpad7, this.IncrementCount)
                .Add(Code.Numpad8, this.IncrementCount)
                .Add(Code.Numpad9, this.IncrementCount)
                .Add(Code.NumpadDecimal, this.IncrementCount)
                
                .Add(ModCode.Shift, Code.Numpad0, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad1, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad2, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad3, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad4, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad5, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad6, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad7, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad8, this.DecrementCount)
                .Add(ModCode.Shift, Code.Numpad9, this.DecrementCount)
                .Add(ModCode.Shift, Code.NumpadDecimal, this.DecrementCount);

            this.HotKeys.KeyDown += HotKeys_KeyDown;
            this.StateHasChanged();
        }
    }

    private void IncrementCount()
    {
        _currentCount++;
    }

    private void DecrementCount()
    {
        _currentCount--;
    }

    private void OnTriggerDisabledState()
    {
        if (_hotKeysContext is null) return;
        var hotKeyY = _hotKeysContext.GetHotKey(Code.Y);
        hotKeyY.State.Disabled = !hotKeyY.State.Disabled;
    }

    private void HotKeys_KeyDown(object? sender, HotKeyDownEventArgs e)
    {
        if (e.Modifiers == ModCode.Ctrl && e.Code == Code.A && e.IsWasm)
        {
            e.PreventDefault = true;
        }
    }

    public async ValueTask DisposeAsync()
    {
        this.HotKeys.KeyDown -= HotKeys_KeyDown;
        if (this._hotKeysContext is not null) await this._hotKeysContext.DisposeAsync();
    }
}
